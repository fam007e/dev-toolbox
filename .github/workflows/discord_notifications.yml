name: Discord Notification

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  pull_request_review:
    types: [submitted]
  issues:
    types: [opened, closed, reopened]
  release:
    types: [published]
  check_run:
    types: [completed]
  check_suite:
    types: [completed]
  deployment:
  deployment_status:

permissions:
  contents: read

jobs:
  discord_notification:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Debug Event
        run: |
          echo "Event Name: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "Push Commit: ${{ github.event.head_commit.url }}"
          fi

      - name: Send notification to Discord for Push
        if: github.event_name == 'push'
        env:
          REPOSITORY: ${{ github.repository }}
          ACTOR: ${{ github.actor }}
          REF_NAME: ${{ github.ref_name }}
          SHA: ${{ github.sha }}
          COMMIT_URL: ${{ github.event.head_commit.url }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          CONTENT="üöÄ **Push Event** in \`$REPOSITORY\` by **$ACTOR**

          Branch: \`$REF_NAME\`
          Commit: [\`$SHA\`]($COMMIT_URL)"
          PAYLOAD=$(jq -n --arg content "$CONTENT" '{"content": $content}')
          curl -X POST \
               -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "$DISCORD_WEBHOOK_URL"

      - name: Send notification to Discord for Pull Request
        if: github.event_name == 'pull_request'
        env:
          ACTION: ${{ github.event.action }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          REPOSITORY: ${{ github.repository }}
          ACTOR: ${{ github.actor }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          CONTENT="üìã **Pull Request ${ACTION^}** in \`$REPOSITORY\` by **$ACTOR**

          [#$PR_NUMBER: $PR_TITLE]($PR_URL)"
          PAYLOAD=$(jq -n --arg content "$CONTENT" '{"content": $content}')
          curl -X POST \
               -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "$DISCORD_WEBHOOK_URL"

      - name: Send notification to Discord for Pull Request Review
        if: github.event_name == 'pull_request_review'
        env:
          REVIEW_STATE: ${{ github.event.review.state }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          REPOSITORY: ${{ github.repository }}
          ACTOR: ${{ github.actor }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          CONTENT="üëÄ **Pull Request Review ${REVIEW_STATE^}** in \`$REPOSITORY\` by **$ACTOR**

          [#$PR_NUMBER: $PR_TITLE]($PR_URL)"
          PAYLOAD=$(jq -n --arg content "$CONTENT" '{"content": $content}')
          curl -X POST \
               -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "$DISCORD_WEBHOOK_URL"

      - name: Send notification to Discord for Issues
        if: github.event_name == 'issues'
        env:
          ACTION: ${{ github.event.action }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          REPOSITORY: ${{ github.repository }}
          ACTOR: ${{ github.actor }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          CONTENT="üêõ **Issue ${ACTION^}** in \`$REPOSITORY\` by **$ACTOR**

          [#$ISSUE_NUMBER: $ISSUE_TITLE]($ISSUE_URL)"
          PAYLOAD=$(jq -n --arg content "$CONTENT" '{"content": $content}')
          curl -X POST \
               -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "$DISCORD_WEBHOOK_URL"

      - name: Send notification to Discord for Release
        if: github.event_name == 'release'
        env:
          ACTION: ${{ github.event.action }}
          RELEASE_NAME: ${{ github.event.release.name }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          RELEASE_URL: ${{ github.event.release.html_url }}
          REPOSITORY: ${{ github.repository }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          CONTENT="üéâ **Release ${ACTION^}** in \`$REPOSITORY\`

          [$RELEASE_NAME ($RELEASE_TAG)]($RELEASE_URL)"
          PAYLOAD=$(jq -n --arg content "$CONTENT" '{"content": $content}')
          curl -X POST \
               -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "$DISCORD_WEBHOOK_URL"

      - name: Send notification to Discord for Check Run
        if: github.event_name == 'check_run'
        env:
          CHECK_NAME: ${{ github.event.check_run.name }}
          CHECK_STATUS: ${{ github.event.check_run.status }}
          CHECK_CONCLUSION: ${{ github.event.check_run.conclusion }}
          REPOSITORY: ${{ github.repository }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          CONTENT="‚úÖ **Check Run Completed** in \`$REPOSITORY\`

          Check: \`$CHECK_NAME\`
          Status: $CHECK_STATUS
          Result: $CHECK_CONCLUSION"
          PAYLOAD=$(jq -n --arg content "$CONTENT" '{"content": $content}')
          curl -X POST \
               -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "$DISCORD_WEBHOOK_URL"

      - name: Send notification to Discord for Check Suite
        if: github.event_name == 'check_suite'
        env:
          CHECK_STATUS: ${{ github.event.check_suite.status }}
          CHECK_CONCLUSION: ${{ github.event.check_suite.conclusion }}
          REPOSITORY: ${{ github.repository }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          CONTENT="üìä **Check Suite Completed** in \`$REPOSITORY\`

          Status: $CHECK_STATUS
          Result: $CHECK_CONCLUSION"
          PAYLOAD=$(jq -n --arg content "$CONTENT" '{"content": $content}')
          curl -X POST \
               -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "$DISCORD_WEBHOOK_URL"

      - name: Send notification to Discord for Deployment
        if: github.event_name == 'deployment' || github.event_name == 'deployment_status'
        env:
          DEPLOY_ENV: ${{ github.event.deployment.environment }}
          DEPLOY_STATUS: ${{ github.event.deployment_status.state }}
          REPOSITORY: ${{ github.repository }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ "${{ github.event_name }}" == "deployment_status" ]; then
            CONTENT="üöÄ **Deployment Status: ${DEPLOY_STATUS^^}** in \`$REPOSITORY\`

            Environment: \`$DEPLOY_ENV\`"
          else
            CONTENT="üöÄ **Deployment Created** in \`$REPOSITORY\`

            Environment: \`$DEPLOY_ENV\`"
          fi
          PAYLOAD=$(jq -n --arg content "$CONTENT" '{"content": $content}')
          curl -X POST \
               -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "$DISCORD_WEBHOOK_URL"
